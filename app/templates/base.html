<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}System Monitor{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Interact.js for draggable/resizable modals -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.11/dist/interact.min.js"></script>
    {% block extra_css %}{% endblock %}
</head>

<body>
    {% if current_user.is_authenticated %}
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>System Monitor</h2>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('main.index') }}" class="{% if request.endpoint == 'main.index' %}active{% endif %}"
                    data-title="Dashboard">
                    <i class="fa-solid fa-gauge-high fa-fw icon"></i> <span>Dashboard</span>
                </a></li>
            <li><a href="{{ url_for('main.processes') }}"
                    class="{% if request.endpoint == 'main.processes' %}active{% endif %}" data-title="Processes">
                    <i class="fa-solid fa-microchip fa-fw icon"></i> <span>Processes</span>
                </a></li>
            <li><a href="{{ url_for('main.alerts_page') }}"
                    class="{% if request.endpoint == 'main.alerts_page' %}active{% endif %}" data-title="Alerts">
                    <i class="fa-solid fa-bell fa-fw icon"></i> <span>Alerts</span>
                </a></li>
            <li><a href="{{ url_for('main.servers_page') }}"
                    class="{% if request.endpoint == 'main.servers_page' %}active{% endif %}" data-title="Servers">
                    <i class="fa-solid fa-server fa-fw icon"></i> <span>Servers</span>
                </a></li>
            <li><a href="{{ url_for('main.health_dashboard') }}"
                    class="{% if request.endpoint == 'main.health_dashboard' %}active{% endif %}" data-title="Health">
                    <i class="fa-solid fa-heart-pulse fa-fw icon"></i> <span>Health</span>
                </a></li>
            <li><a href="{{ url_for('main.settings') }}"
                    class="{% if request.endpoint == 'main.settings' %}active{% endif %}" data-title="Settings">
                    <i class="fa-solid fa-gear fa-fw icon"></i> <span>Settings</span>
                </a></li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-name">{{ current_user.username }}</span>
                {% if current_user.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
            </div>
            <a href="{{ url_for('auth.profile') }}" class="profile-link" data-title="Profile">
                <i class="fa-solid fa-user fa-fw icon"></i> <span>Profile</span>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="logout-link" data-title="Logout">
                <i class="fa-solid fa-right-from-bracket fa-fw icon"></i> <span>Logout</span>
            </a>
        </div>
        <div class="sidebar-resizer"></div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content {% if not current_user.is_authenticated %}no-sidebar{% endif %}">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">
                {{ message }}
                <button class="close-flash" onclick="this.parentElement.remove()">Ã—</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Top bar with date/time removed from fixed position -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/window-manager.js') }}"></script>
    <!-- Initialize Interact.js for modals and datetime -->
    <script>
        // Draggable & resizable modals
        document.addEventListener('DOMContentLoaded', function () {
            interact('.modal-content')
                .draggable({
                    allowFrom: '.modal-header',
                    listeners: {
                        move(event) {
                            const target = event.target;
                            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                            target.style.transform = `translate(${x}px, ${y}px)`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        }
                    }
                })
                .resizable({
                    edges: { left: true, right: true, bottom: true, top: true },
                    listeners: {
                        move(event) {
                            const target = event.target;
                            let x = (parseFloat(target.getAttribute('data-x')) || 0);
                            let y = (parseFloat(target.getAttribute('data-y')) || 0);

                            target.style.width = event.rect.width + 'px';
                            target.style.height = event.rect.height + 'px';

                            x += event.deltaRect.left;
                            y += event.deltaRect.top;

                            target.style.transform = 'translate(' + x + 'px,' + y + 'px)';

                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictSize({
                            min: { width: 300, height: 200 }
                        })
                    ]
                });

            // Vanilla JS Sidebar Resizing
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const resizer = document.querySelector('.sidebar-resizer');
            let isResizing = false;

            if (resizer && sidebar && mainContent) {
                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.body.style.cursor = 'col-resize';
                    sidebar.classList.add('resizing');
                    e.preventDefault(); // Prevent text selection
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    let newWidth = e.clientX;
                    // Constrain width
                    if (newWidth < 80) newWidth = 80;
                    if (newWidth > 500) newWidth = 500;

                    sidebar.style.width = `${newWidth}px`;
                    mainContent.style.marginLeft = `${newWidth}px`;

                    // Collapse logic
                    if (newWidth <= 100) {
                        sidebar.classList.add('collapsed');
                    } else {
                        sidebar.classList.remove('collapsed');
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = 'default';
                        sidebar.classList.remove('resizing');
                    }
                });
            }

            // Date & Time display
            function updateDateTime() {
                const now = new Date();
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                const display = document.getElementById('datetime-display');
                if (display) {
                    // display.textContent = now.toLocaleString(undefined, options);
                    const dateString = now.toLocaleString(undefined, options);
                    // Wrap numbers in span
                    display.innerHTML = dateString.replace(/\d+/g, '<span class="dt-number">$&</span>');
                    display.style.display = 'block'; // Force display
                }
            }
            setInterval(updateDateTime, 1000);
            updateDateTime();
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>